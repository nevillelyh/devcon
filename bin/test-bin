#!/bin/bash

set -euo pipefail

bindir="$(dirname "$(readlink -f "$0")")"
basedir="$(readlink -f "$bindir/..")"
project="$(basename "$basedir")"

pass() {
    echo "[PASS] $*"
}

fail() {
    out=$1
    shift
    echo "[FAIL] $*"
    echo "============================================================"
    cat "$out"
    echo "============================================================"
    rm "$out"
    exit 1
}

test_bin() {
    bin="$1"
    shift
    out=$(mktemp "/tmp/$project-test-XXXXXXXX")
    "$bindir/$bin" "$@" > "$out" 2>&1 || fail "$out" "$bin" "$@"
    rm "$out"
    pass "$bin" "$@"
}

cd "$basedir"
source conf.sh

echo "Setting up environment"
"$bindir/reset"
"$bindir/docker-compose" build
"$bindir/docker-compose" up --detach

for service in "${SERVICES[@]}"; do
    case "$service" in
        metastore-hive)
            "$bindir/wait" metastore-hive
            test_bin shell metastore-hive -c "ls /apache/hive"
            [[ "$METASTORE_DBTYPE" != "derby" ]] && test_bin shell metastore-hive -c \
                "/apache/hive/bin/schematool -dbType $METASTORE_DBTYPE -validate --verbose"
            ;;
        metastore-iceberg)
            "$bindir/wait" metastore-iceberg
            test_bin shell metastore-iceberg -c "ls /apache/hive"
            [[ "$METASTORE_DBTYPE" != "derby" ]] && test_bin shell metastore-iceberg -c \
                "/apache/hive/bin/schematool -dbType $METASTORE_DBTYPE -validate"
            ;;
        minio)
            "$bindir/wait" minio
            test_bin shell minio -c "ls /data"
            test_bin mc ls minio
            ;;
        mariadb)
            "$bindir/wait" mariadb
            test_bin shell mariadb -c "ls /var/lib/mysql"
            test_bin mariadb --execute="SHOW DATABASES"
            ;;
        mysql)
            "$bindir/wait" mysql
            test_bin shell mysql -c "ls /var/lib/mysql"
            test_bin mysql --execute="SHOW DATABASES"
            ;;
        postgres)
            "$bindir/wait" postgres
            test_bin shell postgres -c "ls /var/lib/postgresql"
            test_bin psql --command="SELECT datname FROM pg_database"
            ;;
        scylla)
            "$bindir/wait" scylla
            test_bin shell scylla -c "ls /var/lib/scylla"
            test_bin cqlsh --execute="DESCRIBE KEYSPACES"
            ;;
        trino)
            "$bindir/wait" trino
            test_bin shell trino -c "ls /etc/trino"
            test_bin trino --execute="SHOW CATALOGS"
            ;;
        *)
            echo "[WARN] No tests for service: $service"
            ;;
    esac
done

echo "Tearing down environment"
"$bindir/docker-compose" down
"$bindir/reset"
