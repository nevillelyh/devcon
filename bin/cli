#!/bin/bash

set -euo pipefail

cli="$(basename "$0")"
bindir="$(dirname "$(readlink -f "$0")")"
basedir="$(readlink -f "$bindir/..")"
project="$(basename "$basedir")"
net="${project}_default"
ts=$(date "+%Y%m%d%H%M%S")

cqlsh() {
    tag="scylladb/scylla"
    docker run -it --rm --name "cqlsh-$ts" --network "$net" \
        --user "$(id -u)" \
        --env HOME=/home/devcon \
        --workdir /home/devcon \
        --volume "$basedir/home:/home/devcon:rw" \
        --entrypoint /bin/bash \
        "$tag" \
        cqlsh scylla.devcon.io "$@"
}

mc() {
    tag="minio/mc:latest"
    docker run -it --rm --name "mc-$ts" --network="$net" \
        --user "$(id -u)" \
        --env HOME=/home/devcon \
        --workdir /home/devcon \
        --volume "$basedir/home:/home/devcon:rw" \
        "$tag" \
        "$@"
}

mariadb() {
    tag="mariadb:latest"
    docker run -it --rm --name "mariadb-$ts" --network "$net" \
        --user "$(id -u)" \
        --env HOME=/home/devcon \
        --workdir /home/devcon \
        --volume "$basedir/home:/home/devcon:rw" \
        "$tag" \
        mariadb --host="mariadb.devcon.io" \
        --user=root --password=mariadbpass \
        "$@"
}

mysql() {
    tag="mysql:latest"
    docker run -it --rm --name "mysql-$ts" --network "$net" \
        --user "$(id -u)" \
        --env HOME=/home/devcon \
        --workdir /home/devcon \
        --volume "$basedir/home:/home/devcon:rw" \
        "$tag" \
        mysql --host="mysql.devcon.io" \
        --user=root --password=mysqlpass \
        "$@"
}

psql() {
    tag="postgres:latest"
    docker run -it --rm --name "postgres-$ts" --network "$net" \
        --user "$(id -u)" \
        --env HOME=/home/devcon \
        --env PGPASSWORD=postgrespass \
        --workdir /home/devcon \
        --volume "$basedir/home:/home/devcon:rw" \
        "$tag" \
        psql --host="postgres.devcon.io" \
        --user=postgres \
        "$@"
}

trino() {
    tag="trinodb/trino:latest"
    docker run -it --rm --name "trino-$ts" --network "$net" \
        --volume "$basedir/home:/home/trino:rw" \
        "$tag" \
        trino --server="http://trino.devcon.io:8080" \
        "$@"
}

case "$cli" in
    cqlsh) cqlsh "$@" ;;
    mc) mc "$@" ;;
    mariadb) mariadb "$@" ;;
    mysql) mysql "$@" ;;
    psql) psql "$@" ;;
    trino) trino "$@" ;;
    *)
        echo "Unknown command: $cli"
        exit 1
        ;;
esac
