#!/bin/bash

set -euo pipefail

bindir="$(dirname "$(readlink -f "$0")")"
basedir="$(readlink -f "$bindir/..")"
project="$(basename "$basedir")"

wait_for_log() {
    container=$1
    expected=$2
    echo "[INFO] Waiting for container $container"
    while ! docker logs "$container" 2>&1 | grep -q "$expected"; do
        sleep 1
    done
    echo "[INFO] Container $container is up"
}

cd "$basedir"
source conf.sh

echo "Setting up environment"
"$bindir/reset"
"$bindir/docker-compose" build
"$bindir/docker-compose" up --detach

wait_for_log "$project-trino-1" "======== SERVER STARTED ========"
"$bindir/trino" --execute="$(cat "$basedir/data/test/test.sql")"

echo "Tearing down environment"
"$bindir/docker-compose" down
"$bindir/reset"
